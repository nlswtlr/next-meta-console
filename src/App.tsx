import { useEffect, useState, useReducer, Reducer } from "react";
import { usePathname } from "next/navigation";

import type { MetaConsoleProps } from "./main";
import { queryElements } from "./lib/helper";
import reducer, { initialState, State, Actions } from "./lib/reducer";
import { consoleWrapper, button, svgIcon, tableWrapper, table, closeBtn, ogImage } from "./app.module.css";

/**
 * ------
 * Icons
 * ------
 * globe network by rajakumara from https://thenounproject.com/browse/icons/term/globe-network/ (CC BY 3.0)
 * Close by Kiki Rizky from https://thenounproject.com/browse/icons/term/close/ (CC BY 3.0)
 */
const App = ({}: Omit<MetaConsoleProps, "enabled">) => {
  const pathname = usePathname();
  const [isOpen, setIsOpen] = useState(false);
  const [state, dispatch] = useReducer<Reducer<State, Actions>>(reducer, initialState);

  useEffect(() => {
    queryElements(dispatch);
  }, [pathname]);

  const { title, description, image } = state;

  return (
    <div className={consoleWrapper}>
      {isOpen ? (
        <div className={tableWrapper}>
          <button className={closeBtn} onClick={() => setIsOpen(false)} aria-label="Close Next.js Meta Console">
            <svg width="8" height="8" viewBox="0 0 30 29" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M29.061 0.439012C28.475 -0.146988 27.526 -0.146988 26.94 0.439012L15.001 12.378L3.06101 0.439012C2.47501 -0.146988 1.52601 -0.146988 0.940012 0.439012C0.354012 1.02401 0.354012 1.97501 0.940012 2.56001L12.879 14.499L0.939012 26.439C0.353012 27.024 0.353012 27.975 0.939012 28.56C1.23201 28.853 1.61601 28.999 2.00001 28.999C2.38401 28.999 2.76801 28.853 3.06101 28.56L15 16.621L25.727 27.348L26.333 27.954L26.939 28.56C27.232 28.853 27.616 28.999 28 28.999C28.384 28.999 28.768 28.853 29.061 28.56C29.647 27.975 29.647 27.024 29.061 26.439L28.455 25.833L27.849 25.227L17.122 14.5L29.061 2.56101C29.647 1.97601 29.647 1.02501 29.061 0.440012V0.439012Z"
                fill="currentColor"
              />
            </svg>
          </button>
          <table className={table}>
            <tbody>
              <tr>
                <td>Title</td>
                <td>{title}</td>
              </tr>
              <tr>
                <td>Description</td>
                <td>{description ? description : "/"}</td>
              </tr>
              {image && (
                <tr>
                  <td>Image</td>
                  <td>
                    <a href={image} target="_blank">
                      <img className={ogImage} width="1200" height="630" src={image} alt="" loading="lazy" />
                    </a>
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      ) : (
        <button className={button} onClick={() => setIsOpen(!isOpen)} aria-label="Open Next.js Meta Console">
          <svg
            className={svgIcon}
            width="21"
            height="20"
            viewBox="0 0 94 91"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M85.1 29.3C86.7343 29.3019 88.3351 28.8364 89.7135 27.9586C91.092 27.0807 92.1907 25.8269 92.8801 24.3452C93.5695 22.8634 93.8208 21.2155 93.6045 19.5956C93.3881 17.9757 92.7131 16.4514 91.6591 15.2025C90.605 13.9536 89.2158 13.0321 87.6553 12.5467C86.0947 12.0614 84.428 12.0323 82.8515 12.463C81.275 12.8936 79.8545 13.7661 78.7575 14.9775C77.6605 16.1889 76.9327 17.6887 76.66 19.3H62C59.5766 14.1263 55.8278 9.68558 51.1339 6.42849C46.4401 3.1714 40.9682 1.2138 35.2735 0.754295C29.5788 0.29479 23.8639 1.34973 18.7085 3.8121C13.5532 6.27446 9.14088 10.0566 5.91924 14.7749C2.6976 19.4931 0.781271 24.9796 0.364676 30.6776C-0.051919 36.3756 1.04604 42.0824 3.54717 47.219C6.0483 52.3557 9.86359 56.7394 14.606 59.9254C19.3483 63.1114 24.8491 64.9864 30.55 65.36V72.36C30.55 75.5426 31.8143 78.5949 34.0648 80.8453C36.3152 83.0957 39.3674 84.36 42.55 84.36H76.91C77.5274 86.3709 78.8611 88.0853 80.6584 89.1783C82.4556 90.2713 84.5914 90.6669 86.6609 90.29C88.7303 89.9131 90.5896 88.79 91.8861 87.1335C93.1826 85.4771 93.8263 83.4025 93.695 81.3031C93.5638 79.2037 92.6669 77.2255 91.1742 75.7434C89.6815 74.2613 87.6969 73.3784 85.5966 73.2621C83.4963 73.1458 81.4264 73.8042 79.7792 75.1125C78.1321 76.4208 77.0222 78.2879 76.66 80.36H42.55C40.4283 80.36 38.3935 79.5172 36.8932 78.0169C35.3929 76.5166 34.55 74.4817 34.55 72.36V65.38C42.681 64.9309 50.3423 61.4271 56 55.57H76.91C77.5274 57.5809 78.8611 59.2953 80.6584 60.3883C82.4556 61.4813 84.5914 61.8769 86.6609 61.5C88.7303 61.1231 90.5896 60 91.8861 58.3435C93.1826 56.6871 93.8263 54.6125 93.695 52.5131C93.5638 50.4137 92.6669 48.4355 91.1742 46.9534C89.6815 45.4713 87.6969 44.5884 85.5966 44.4721C83.4963 44.3558 81.4264 45.0142 79.7792 46.3225C78.1321 47.6308 77.0222 49.4979 76.66 51.57H59.28C62.1271 47.5044 63.9996 42.8376 64.7522 37.9316C65.5049 33.0256 65.1175 28.0122 63.62 23.28H76.92C77.4651 25.0235 78.5524 26.5476 80.0236 27.6304C81.4949 28.7131 83.2733 29.2981 85.1 29.3ZM85.1 16.16C86.0039 16.16 86.8875 16.428 87.639 16.9302C88.3905 17.4324 88.9763 18.1461 89.3222 18.9812C89.6681 19.8162 89.7586 20.7351 89.5822 21.6216C89.4059 22.5081 88.9706 23.3224 88.3315 23.9615C87.6924 24.6006 86.8781 25.0359 85.9916 25.2122C85.1051 25.3885 84.1862 25.298 83.3512 24.9521C82.5161 24.6063 81.8024 24.0205 81.3002 23.269C80.7981 22.5174 80.53 21.6339 80.53 20.73C80.53 19.518 81.0115 18.3556 81.8686 17.4985C82.7256 16.6415 83.888 16.16 85.1 16.16ZM23.44 6.22002C20.665 8.98192 18.43 12.2377 16.85 15.82C15.476 14.8898 14.1876 13.839 13 12.68C15.968 9.79202 19.5311 7.58729 23.44 6.22002ZM10.31 15.66C11.8669 17.1623 13.5723 18.5025 15.4 19.66C14.2215 23.3591 13.5487 27.2006 13.4 31.08H4.40005C4.78963 25.466 6.84763 20.0963 10.31 15.66ZM4.41005 35.04H13.41C13.5519 38.9325 14.2213 42.7876 15.4 46.5C13.5723 47.6575 11.8669 48.9977 10.31 50.5C6.8438 46.0514 4.7889 40.6669 4.41005 35.04ZM13 53.41C14.1971 52.2496 15.4956 51.1988 16.88 50.27C18.4598 53.8524 20.6948 57.1083 23.47 59.87C19.5504 58.5067 15.9767 56.3017 13 53.41ZM30.73 60.5C26.0821 57.614 22.4554 53.3439 20.36 48.29C23.6136 46.7341 27.1321 45.8078 30.73 45.56V60.5ZM30.73 41.56C26.6709 41.8001 22.6926 42.7973 19 44.5C18.1022 41.418 17.585 38.2377 17.46 35.03H30.73V41.56ZM30.73 31.06H17.44C17.5708 27.8481 18.0947 24.6644 19 21.58C22.6947 23.3059 26.6803 24.3235 30.75 24.58L30.73 31.06ZM30.73 20.54C27.1315 20.2891 23.6129 19.3594 20.36 17.8C22.4572 12.7498 26.0837 8.48338 30.73 5.60002V20.54ZM85.1 77.21C86.0039 77.21 86.8875 77.478 87.639 77.9802C88.3905 78.4824 88.9763 79.1961 89.3222 80.0312C89.6681 80.8662 89.7586 81.7851 89.5822 82.6716C89.4059 83.5581 88.9706 84.3724 88.3315 85.0115C87.6924 85.6506 86.8781 86.0859 85.9916 86.2622C85.1051 86.4385 84.1862 86.348 83.3512 86.0021C82.5161 85.6563 81.8024 85.0705 81.3002 84.319C80.7981 83.5674 80.53 82.6839 80.53 81.78C80.53 80.568 81.0115 79.4056 81.8686 78.5485C82.7256 77.6915 83.888 77.21 85.1 77.21ZM85.1 48.5C86.0039 48.5 86.8875 48.768 87.639 49.2702C88.3905 49.7724 88.9763 50.4861 89.3222 51.3212C89.6681 52.1562 89.7586 53.0751 89.5822 53.9616C89.4059 54.8481 88.9706 55.6624 88.3315 56.3015C87.6924 56.9406 86.8781 57.3759 85.9916 57.5522C85.1051 57.7285 84.1862 57.638 83.3512 57.2921C82.5161 56.9463 81.8024 56.3605 81.3002 55.609C80.7981 54.8574 80.53 53.9739 80.53 53.07C80.53 51.858 81.0115 50.6956 81.8686 49.8385C82.7256 48.9815 83.888 48.5 85.1 48.5ZM61 31.04H52C51.8574 27.1403 51.1845 23.2782 50 19.56C51.8169 18.4002 53.5121 17.0601 55.06 15.56C58.5444 20.0094 60.6136 25.4019 61 31.04ZM52.41 12.61C51.2252 13.7679 49.9402 14.8187 48.57 15.75C46.9889 12.194 44.7612 8.96254 42 6.22002C45.892 7.57062 49.444 9.75094 52.41 12.61ZM34.73 5.61001C39.3615 8.48298 42.9799 12.7307 45.08 17.76C41.8363 19.325 38.3232 20.255 34.73 20.5V5.61001ZM34.73 24.55C38.7978 24.301 42.7815 23.283 46.47 21.55C47.3663 24.6389 47.8801 27.826 48 31.04H34.73V24.55ZM34.73 35.06H48C47.8752 38.2816 47.3546 41.4755 46.45 44.57C42.7614 42.8372 38.7778 41.8193 34.71 41.57L34.73 35.06ZM34.73 60.51V45.56C38.3252 45.8144 41.8384 46.7547 45.08 48.33C42.9835 53.3667 39.3647 57.6218 34.73 60.5V60.51ZM42 59.87C44.7576 57.1266 46.9819 53.8952 48.56 50.34C49.9345 51.2771 51.223 52.3346 52.41 53.5C49.4421 56.3519 45.8903 58.5253 42 59.87ZM55.09 50.5C53.533 48.998 51.8276 47.6579 50 46.5C51.1845 42.7818 51.8574 38.9197 52 35.02H61C60.6222 40.6549 58.5636 46.047 55.09 50.5Z"
              fill="currentColor"
            />
          </svg>
        </button>
      )}
    </div>
  );
};

export default App;
